#!/bin/env python3

# flashfact control 
# Pete Moore Mar 2018

import os
import sys
from os.path import join, dirname, abspath, exists
from cmd  import Cmd
import model.db
from model.cta import CTAArrival, CTARoute
from state import AppState 
import logging
from subprocess import Popen
import signal

import helpers
from mycolor import blue

appstate = AppState()  
appstate.datadir = abspath( dirname(__file__) ) # make the tests dir the datadir
appstate.offline = False                        # pull all data from URL sources.

appstate.database = 'flashfact'
appstate.online = True
appstate.databasetype = 'sqlite'
appstate.sqlite_store = '/tmp'
appstate.new_thing = [1,2,3]


logger = logging.getLogger()
helpers.setup_logger(logger, stdout=True)

blue_line = blue("=============================================================")
print("\n"+blue_line)
print( blue("*") + " flashfact control menu. If lost try help or autocomplete. " + blue("*"))
print(blue_line)
class FlashFact(Cmd):
    prompt = '(flashfact command) '
    daemonpid = None
    
    def __init__(self):
        super().__init__()
        self.cache = None
        
    def do_create_db(self, s):
        '''Non-destructive creation of main database. i.e. If database already exists, nothing happens.'''
        db = model.db.DB("ctatest")
        
        if appstate.databasetype == "sqlite":
            filename = '{sqlite_store}/{database}.db'.format(**vars(appstate.instance))
            db.sqlite(filename) # select method as sqlite with filename
        db.create()
        print("sqlite database location {filename}".format(filename=filename))
        
    def do_drop_and_create(self,s):
        if s != 'y':
            if input("are you sure you want to recreate database and lose all data?").lower().startswith('y'):
                print("dropping database")
                filename = '{sqlite_store}/{database}.db'.format(**vars(appstate.instance))
                os.remove(filename)
                self.do_create_db("")
    
    def emptyline(self):
        pass
    
    def do_exit(self, s):
        appstate.save_state()
        return True
        
        
    def do_appstate(self, s):
        appstate.dump_state()
        
    def do_loadstate(self,s):
        appstate.load_state()
        
        
    def do_quit(self, s):
        return self.do_exit()
        
    def do_test(self, s):
        '''Whatever tests I\'m doing '''
        print('{sqlite_store}/{database}.db'.format(**vars(appstate.instance)))
        
        for i in vars(appstate.instance):
            print(i)
        
        filename =  '%s/%s' % ( os.getenv("HOME", '/tmp'), '.flashfactrc')
        print("state file is", filename)
        appstate.dump_state()
        appstate.save_state()
        
    def do_restart(self, s):
        '''restart this menu'''
        os.execv( __file__, sys.argv[0:] )
        
    def do_reload(self,s):
        return self.do_restart(s)
        
    def do_cta_tracker(self, s):
        '''Enter the CTA tracker submenu'''
        os.execv( dirname(__file__) + '/cta_trackercmd', sys.argv[0:] )
        
    def do_start_deamon(self,s):
        if self.daemonpid:
            print
        self.daemonpid = Popen(["flashfactd"]).pid
        #self.daemonpid = Popen(["flashfactd", ">>",  "/dev/null"]).pid
        appstate.daemonpid = self.daemonpid
        appstate.save_state()
        print(self.daemonpid)
        
    def do_stop_daemon(self,s):
        #if self.daemonpid and os.kill(self.daemonpid, 0):
        os.kill(self.daemonpid, signal.SIGINT)
        self.daemonpid = None
        appstate.save_state()
        
    def do_tickle(self, s):
        if self.daemonpid:
            os.kill(self.daemonpid, 40)
            
               
        
    

if __name__ == "__main__":
     
    menu = FlashFact()
    menu.cmdloop()
    
  
        
        
    